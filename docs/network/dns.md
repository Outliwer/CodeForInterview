## `DNS`解析域名过程
* 参考计网书上
    * 准备：`DHCP、UDP、IP`和以太网 （获取**机器`IP`**）
    
        * 电脑操作系统生成一个 `DHCP` 报文，将该报文放入到`UDP`报文段（目的地端口号`67`，源端口号`68`），`UDP`报文段被放入一个`IP`数据报（目的地址：`255.255.255.255`，源地址：`0.0.0.0`）中
        
        * `IP`数据报被放置到一个以太网帧中。其中目的`MAC`地址：`FF:FF:FF:FF:FF:FF`（这样会将该以太网帧广播到与交换机连接的所有的**所有设备**中）源`MAC`地址是本机`MAC`地址
        * 路由器收到广播的**以太网帧**（在这之前先会到**交换机**，交换机在所有的出端口**广播入帧**），通过广播`IP`地址指示应该由更高层的**协议**进行处理，`DHCP`报文从`UDP`抽离出来，因此`DHCP`服务器有了`DHCP`请求报文
        * `DHCP`服务器可以通过`CIDR`块（`IP`地址的子网分配，类似于前几个地址指定**某一段区域**）分配`IP`地址。`DHCP`服务器生成包含**分配的`IP`**以及`DNS`服务器的`IP`地址，**默认网关路由器**的`IP`地址和**子网块**的一个`DHCP ACK报文`放入`UDP`报文段，`UDP`报文段被放入一个`IP`数据报
        * `IP`数据报被放置到一个以太网帧中（源`MAC`地址是路由器连到归属网络时接口的`MAC`地址，目的`MAC`地址电脑的`MAC`地址）
        * 首先以太网帧会发送到**交换机**中，所以交换机知道知道直接寻址，可以只发送到**电脑操作系统**中
        * 电脑收到包含`DHCP ACK`的以太网帧，从该以太网帧中抽取`IP`数据报，进而抽取`UDP`报文段。`DHCP`客户则记录下`IP`地址和**`DNS`服务器的`IP`地址**。同时在`IP`转发表中安装默认网关的地址。电脑将向**默认网关**发送**目的地址为其子网以外的所有数据报**
    * 准备：`DNS`和`APR`
        * 生成一个`DNS`查询报文，将字符串`www.baidu.com`放入报文的问题段中。`DNS`报文放置在一个具有`53`号目的端口的`UDP`报文段中。该`UDP`报文被放入一个具有`IP`目的地址为上述`DNS`服务器的`IP`报文
        
        * 放入以太网帧中，发送到学校网络中的网关路由器。此时进行`APR`寻址查找**网关路由器**的**`MAC`地址**
        
        * 接下来进行`APR`寻址
            * 电脑生成一个具有目的`IP`地址（默认网关`IP`）的`APR`查询报文，放入一个具有广播目的地址（`FF:FF:FF:FF:FF:FF`）的以太网帧中
            
            * 在交换机进行广播到**网关路由器**，发现存在匹配以后进行`APR`应答，此时以太网帧的目标地址为电脑的`MAC`地址，向交换机发送该帧
            
            * 电脑得到网关路由器的**`MAC`地址**，将具有`IP`目的地址为上述`DNS`服务器的`IP`报文放入目标地址为**网关路由器**的**`MAC`地址**的以太网帧中
    * 准备：域内路由选择到`DNS`服务器（即`LDNS`）
        * **网关路由器**接受该帧并抽取包含`DNS`查询的`IP`数据报
    * 交互：`TCP`和`HTTP`
        
        * 生成`TCP`套接字，向`www.baidu.com`发送`HTTP GET`报文。发生**三次握手**
            * 电脑发送具有目的端口`80`的`TCP SYN`报文段
            
            * 将该报文段放置目的`IP`地址的`IP`数据报之中
            * 将该`IP`数据报放置到`MAC`地址为网关路由器的**以太网帧**中
            * 向交换机发送该帧
            * 将网络分为：学校网络、`Comcast`网络、百度网络
            * 从学校网络到百度网络中，使用每台路由器的**转发表**，链路转发的路由器转发表项由**`BGP`协议**决定
            * 最终包含`TCP SYN`的`IP`数据报到达`www.baidu.com`，并从其中抽取出`TCP SYN`报文并**分解为**与端口`80`的相联系的套接字，产生一个`TCP SYNACK`报文端
            * 放入向电脑寻址的一个数据报中，最后放入链路层帧中（链路适合为**第一跳**路由器）
            * 在之前生成的`TCP`套接字改变状态变为连接
            * 通过`HTTP GET`报文和`HTTP`响应报文来完成

* 不懂的几个概念：
    * 默认网关
        * 对于每个**自治系统**中，负责向本`AS`以外的目的地转发分组的路由器称为**网关路由器**
        * 其中默认的则为默认网关 
    * 交换机
        * 是第二层的分组交换机（**链路层**）
        * 交换机负责同一网段的通信
        * 接收入**链路层帧**并将其转发出**链路**
        * 交换机表
            * `MAC`地址
            * 通向`MAC`地址的交换机接口
            * 表项放置在表中的时间
            * 相当于对应了`MAC`地址的出口
        * 自学习
            * 进行表项的更新以及过期删除
                * 最终接口存储的是**帧**到达的接口 
            * 任何交换机的接口能够同时发送和接受
            
        * 实际工作情况
            * 目标地址的帧进来**没有**相关表项，则进行广播
            * 如果有该表项的记录
                * 当接口一样时则忽略
                * 不一样的时候（表示有**新的帧**进入）则转发 
        
    * 路由器
        * 实现转发和路由功能
            * 转发
                * 当一个分组到达路由器的一条**输入**链路时，路由器进行分组移动到合适的链路**输出**（`IP`层面） 
            * 路由 
                * **路由选择**算法 
        * 是第三层的分组交换机 （**网络层**）
        * 转发表
            * 首部值
            * 输出链路 
            
    * 第一跳路由器
    * 实际电脑中关于`DNS`到`IP`的变换
        * 在浏览器中输入`www.qq.com`域名，会检测浏览器缓存是否存储着域名对应的关系
        
        * 接下来会检测本地的`hosts`文件是否有网址的映射关系。如果存在映射关系就先使用该`IP`完成对域名的解析
        
        * 如果本地`hosts`文件没有该域名解析，则查找本地`DNS`解析器缓存，如果有则直接返回完成映射
        * 如果`hosts`文件和本地`DNS`解析器缓存都没有，则会查找`TCP/IP`参数中设置的首选`DNS`服务器（`LDNS`）收到查询解析（为**上述模式**中的一部分），在本地配置区域文件中，返回结果给客户机，该解析具有**权威性**
        * 如果要查询的域名，不由本地`DNS`服务器区域解析，但该服务器已经进行了缓存，则可以直接调用，该解析**不具有**权威性
        * 如果`LDNS`没有能够命中，则要根据`LDNS`的设置：
            * 设置了转发模式
            
                * 此`DNS`服务器就会把请求转发至上一级`DNS`服务器，由上一级服务器进行解析
                
            * 没有设置转发模式 
                *  `LDNS`将请求发送至`13`台根`DNS`
                
                *  根`DNS`服务器收到请求后会判断这个域名(`.com`)是谁来授权管理，并会返回一个负责该顶级域名服务器的一个`IP`
                *  `LDNS`将会联系该`IP`，如果该`IP`对应的服务器无法解析，则返回下一层服务器的一个`IP`
                
                *  直到完成解析
        * 请求主机到 `LDNS`是递归的，其余查询是迭代的
    * `BGP`协议
        *  

